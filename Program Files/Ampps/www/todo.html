<?php
include("auth.html");
?>
<!DOCTYPE html>
<html>
  <head>
    <title>7days</title>
    <link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore.js"></script>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      // Creating a cookie after the document is ready
      Date.prototype.addDays = function(days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
      }
      var date0 = new Date;
      var date1;
      if(date0.getDay() === 0){
        date1 = date0.addDays(1);
      } else if(date0.getDay() === 1){
        date1 = date0;
      } else if(date0.getDay() === 2){
        date1 = date0.addDays(-1);
      } else if(date0.getDay() === 3){
        date1 = date0.addDays(-2);
      } else if(date0.getDay() === 4){
        date1 = date0.addDays(-3);
      } else if(date0.getDay() === 5){
        date1 = date0.addDays(-4);
      } else if(date0.getDay() === 6){
        date1 = date0.addDays(-5);
      }
      //sets date to monday of that week

     function ordinal_suffix_of(i) {
        var j = i % 10,
            k = i % 100;
        if (j == 1 && k != 11) {
            return i + "st";
        }
        if (j == 2 && k != 12) {
            return i + "nd";
        }
        if (j == 3 && k != 13) {
            return i + "rd";
        }
        return i + "th";
      }

      var date = date1.getMonth()+1 + "/" + date1.getDate() + "/" + date1.getFullYear();
      const urlParams = new URLSearchParams(window.location.search);

      function textDateUpdate() {
        var dateselected = date1;
        if(urlParams.get("sel") !== null){
          dateselected.setMonth(urlParams.get("sel").split('/')[0]-1);
          dateselected.setDate(urlParams.get("sel").split('/')[1]);
          dateselected.setFullYear(urlParams.get("sel").split('/')[2]);
        }
        var date2 = dateselected.addDays(1);
        var date3 = date2.addDays(1);
        var date4 = date3.addDays(1);
        var date5 = date4.addDays(1);
        var tablename = "Schedule (" + (dateselected.getMonth()+1) + "/" + dateselected.getDate() + "-" + (date5.getMonth()+1) + "/" + date5.getDate() +")";
        document.getElementById("tablename").innerHTML = tablename;
        document.getElementById("monday").innerHTML = "Mon " + ordinal_suffix_of(dateselected.getDate());
        document.getElementById("tuesday").innerHTML = "Tue " + ordinal_suffix_of(date2.getDate());
        document.getElementById("wednesday").innerHTML = "Wed " + ordinal_suffix_of(date3.getDate());
        document.getElementById("thursday").innerHTML = "Thu " + ordinal_suffix_of(date4.getDate());
        document.getElementById("friday").innerHTML = "Fri " + ordinal_suffix_of(date5.getDate());
      }

      window.onload = (e) => {
        textDateUpdate();
        createCookie("copy", false, 1);
      }

      function selectdate(i) {
        var lastselectedweek = date1.getMonth()+1 + "/" + date1.getDate() + "/" + date1.getFullYear();
        var dateselected = date1.addDays(i);
        if(urlParams.get("sel") !== null){
          dateselected.setMonth(urlParams.get("sel").split('/')[0]-1);
          dateselected.setDate(urlParams.get("sel").split('/')[1]);
          dateselected.setFullYear(urlParams.get("sel").split('/')[2]);
          dateselected = dateselected.addDays(i);
        }
        var dateselectedformated = dateselected.getMonth()+1 + "/" + dateselected.getDate() + "/" + dateselected.getFullYear();
        createCookie("last", lastselectedweek, 1);
        if (dateselectedformated === date) {
          return '/';
        } else {
          return '/?sel=' + dateselectedformated;
        }
      }

      function copy() {
        //window.confirm("Copy Classes?")
        if(true){
          createCookie("copy", true, 1);
        }
      }

      if (getCookie("getTime")==="") {
        createCookie("getTime", date, "1");
        location.reload();
      }

      // Function to create the cookie
      function createCookie(name, value, days) {
        var expires;
        if (days) {
          var date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toGMTString();
        }
        else {
          expires = "";
        }
        document.cookie = escape(name) + "=" + escape(value) + expires + "; path=/";
      }
      function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }
    </script>
  </head>
  <div class="main">
    <div class= "menu">
        <a href="about.html">
            <img src="planner.png" width="100" height="100">
        </a>
        <a href="index.html" class="menufont">This Week</a>
        <a href="weekselector.html" class="menufont">Select Week [Not Implemented Yet]</a>
        <a href="todo.html" class="menufont">To-Do</a>
        <div class="form" style="bottom: 0px; position: absolute;">
            <p>Welcome <?php echo $_SESSION['username']; ?>!</p>
            <a href="dashboard.html">Dashboard</a>
            <a href="logout.html">Logout</a>
        </div>
    </div>
    <div class="body">
      <div class="invest">
        <div class="investbox">
          <h1 style="color: #595959; font: bold 36pt Tahoma,'Segoe UI',Calibri,Thonburi,Arial,Verdana,Sans-Serif,'Mongolian Baiti','Microsoft Yi Baiti','Javanese Text';  background-color:white; margin: 0px; line-height: 80px;" class="Table">To-Do</h1>
          <?php
          $username = $_SESSION['username'];

          $con = mysqli_connect("localhost","root","mysql","$username");
          if (mysqli_connect_errno())
          {
            echo "Failed to connect to MySQL: " . mysqli_connect_error();
          }
          if (!$result = $con->query("DESCRIBE `todo`") ) {
            $con->query("CREATE TABLE `$username`.`todo` (
              content TEXT
            )");
            $con->query("INSERT INTO `$username`.`todo` (content) VALUES ('')");
          }
          $sql_query = "SELECT content FROM `todo`";
          $resultset = mysqli_query($con, $sql_query) or die("database error:". mysqli_error($con));
          while( $developer = mysqli_fetch_assoc($resultset) ) {
          ?>
          <p><?php echo $developer ['content']; ?></p>
          <?php }
          ?>
        </div>
      </div>
    </div>
  </div>
</html>

<script type="text/javascript">
  bottomborder();


  function CellChange(a,b,c) {
    var datesend;
    if(urlParams.get("sel")=== null){
      datesend = date;
    } else {
      datesend = urlParams.get("sel");
    }
    $.ajax({
      method: "POST",
      url: "live_edit.php",
      data: {
        a: a,  //row
        b: b,  //column title
        c: c,  //data
        d: 'change',
        e: datesend
      }
    });
  }

  Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
  }

  function ordinal_suffix_of(i) {
    var j = i % 10,
        k = i % 100;
    if (j == 1 && k != 11) {
        return i + "st";
    }
    if (j == 2 && k != 12) {
        return i + "nd";
    }
    if (j == 3 && k != 13) {
        return i + "rd";
    }
    return i + "th";
  }

  textDateUpdate();
</script>
